#### 背景介绍

&emsp;在公司做了很多关于ldap的工作, 这里总结一下常用的脚本, 以后可能会用到.

#### 查询用户

```python
import ldap3
from ldap3 import Server, Connection, ALL

ldap_addr = "ldap地址"
ldap_port = 端口
ldap_admin_user = "cn=账号,dc=rockywu,dc=me"
ldap_admin_password = "密码"


server = Server(host=ldap_addr, port=ldap_port, get_info=ALL)
conn = Connection(server, user=ldap_admin_user, password=ldap_admin_password)
if conn.bind():
    print("ldap连接成功!")
else:
    raise Exception("连接失败!")
# 
conn.search(search_base="ou=People,dc=rockywu,dc=me", search_filter="(uid=*)", attributes=ldap3.ALL_ATTRIBUTES)

for user in conn.response:
    # 遍历所有的用户
    user_gnumber = user["raw_attributes"]["gidNumber"][0].decode("utf-8")

```


#### 查询用户组

```python
import ldap3
from ldap3 import Server, Connection, ALL

ldap_addr = "ldap地址"
ldap_port = 端口
ldap_admin_user = "cn=账号,dc=rockywu,dc=me"
ldap_admin_password = "密码"


server = Server(host=ldap_addr, port=ldap_port, get_info=ALL)
conn = Connection(server, user=ldap_admin_user, password=ldap_admin_password)
if conn.bind():
    print("ldap连接成功!")
else:
    raise Exception("连接失败!")
# 查询用户组, 搜索条件是cn=1或者cn=1-*
conn.search(search_base="ou=Group,dc=rockywu,dc=me", search_filter="(|(cn=1)(cn=1-*))", attributes=ldap3.ALL_ATTRIBUTES)
for group in conn.response:
    # 遍历所有的用户组
    pass

```

#### 修改密码

```python
import ldap3
from ldap3 import Server, Connection, ALL, MODIFY_REPLACE, HASHED_SALTED_SHA
from ldap3.utils.hashed import hashed
ldap_addr = "ldap地址"
ldap_port = 端口
ldap_admin_user = "cn=账号,dc=rockywu,dc=me"
ldap_admin_password = "密码"


server = Server(host=ldap_addr, port=ldap_port, get_info=ALL)
conn = Connection(server, user=ldap_admin_user, password=ldap_admin_password)
if conn.bind():
    print("ldap连接成功!")
else:
    raise Exception("连接失败!")

dn = "uid={0},ou=People,dc=rockywu,dc=me".format(user_uid)
hashed_password = hashed(HASHED_SALTED_SHA, "plain password")
changes = {"userPassword": [(MODIFY_REPLACE, [hashed_password])]}
conn.modify(dn, changes)
if conn.result.get("description") != "success":
    print("process failed: {0}".format(user_uid))
    continue
```

#### 删除用户

```python
import ldap3
from ldap3 import Server, Connection, ALL

ldap_addr = "ldap地址"
ldap_port = 端口
ldap_admin_user = "cn=账号,dc=rockywu,dc=me"
ldap_admin_password = "密码"


server = Server(host=ldap_addr, port=ldap_port, get_info=ALL)
conn = Connection(server, user=ldap_admin_user, password=ldap_admin_password)
if conn.bind():
    print("ldap连接成功!")
else:
    raise Exception("连接失败!")

dn = "uid={0},ou=People,dc=rockywu,dc=me".format(user_uid)

conn.delete(dn)
# return True if success else False
print(conn.result)
```



