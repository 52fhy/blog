#### Playbook简介

&emsp;我们已经学会了如何从命令行来执行ansible任务, 这还不够强大, ansible引入了剧本的概念, 用来解决更加复杂的场景. 下面列出一个来学习:

```yaml
---
- hosts: all
  gather_facts: no
  tasks:
    - name: 创建test用户
      user:
        name: test
        comment: test user
        uid: 600
        group: root
    - name: 安装{{ software }}软件
      yum:
        name: "{{ software }}"
        state: latest
    - name: 测试
      shell: pwd
      become_user: test
```

一般来说, 我们会把需要执行任务的主机放到一个文件中, 如下:

```
hosts.txt
1.1.1.1 software="nc"
2.2.2.2 software="nc"
```

执行如下:

```
ansible-playbook -i hosts.txt test.yaml
```

#### Playbook格式介绍

playbook的格式是采用的yaml格式, 一般开头是`---`,  不写也没关系.`gather_facts`的作用是在每次执行任务之前会获取主机的基本信息, 来供下面的任务使用,  一般如果你的任务中不使用这些变量的时候, 应该显性关闭, 会提高性能.

下面就是tasks任务了, 一般每个任务都是一个模块, `name`属性是每个任务的名称, 这在查看结果的时候非常有用, 建议写明白些.下面的模块和属性可以分行写, 也可以写到一行.

#### 结果分析

上面的命令执行完以后, 结果如下:

```
PLAY [all] **************************************************************************************************************************************************************************

TASK [创建test用户] *********************************************************************************************************************************************************************
ok: [rockywu.me]

TASK [安装nc软件] ***********************************************************************************************************************************************************************
ok: [rockywu.me]

TASK [测试] ***************************************************************************************************************************************************************************
changed: [rockywu.me]

PLAY RECAP **************************************************************************************************************************************************************************
rockywu.me                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

最后一行是结果, 第一版异步任务平台就是通过程序解析这个来判断任务的成功失败的. `ok`是本来就是成功的, 没有任何动作, `changed`是执行完成并成功, `unreachable`是网络不通, `failed`是执行失败, `skipped`是逻辑上判断跳过该任务.

#### 参数传递

如果单独使用ansible执行命令倒使用不到参数, 如果是作为一个任务平台的话, 肯定是需要参数传递的, playbook中使用的`Jinja2`模板渲染的, 可以把参数写到hosts文件中, 每一个ip都有自己的参数, 然后可以在playbook中使用.

#### roles

playbook对于module来说已经很强大了, 但是单单一个playbook文件有时候能力还不够强, 复用性也不够, 这里提出了roles的概念, 其实就是规定了一些约定的目录结构, 如下示例:

```
roles/
   common/
     tasks/
     handlers/
     files/
     templates/
     vars/
     defaults/
     meta/
   webservers/
     tasks/
     defaults/
     meta/
```

* tasks 放置playbook脚本
* handlers 放置事件触发的任务, 比如某个task执行完以后会触发某个动作, 这里定义这些动作
* files tasks中使用到的文件都会放到这里, 比如某些软件安装包
* templates 一些配置文件的模板, 比如Nginx的模板配置文件, 里面可以使用变量, 用于直接复制到远程服务器等
* vars 用到的变量都会写到这里
* defaults 默认的变量值
* meta 

一些基本的约定, 默认上述文件夹中文件的名称为`main.yml`, 用到就创建相关的文件夹, 用不到就不用创建就行.

在playbook中使用roles:

```
---
- hosts: webservers
  roles:
    - common
    - webservers
    - {role: pubkey, when: install_flag == 1}
```

> 变量尽量不使用短横杠, 尽量使用下划线



