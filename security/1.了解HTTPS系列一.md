#### 背景介绍

&emsp;最近忙了一阵子替换线上域名HTTPS证书的工作, 突然想了一下, 自己干运维已经5年了, 配置Nginx的HTTPS证书的工作很早已经会了, 但是现在依然停留在对https了解很浅的层次, 只是知道https比http更加安全, 具体为啥会更加安全, 自己却浑然不知, 一直这样下去的话, 即使工作时间再长, 自己的技术肯定不会有什么进步的, 也就没什么竞争力了, 为了能够不断提高自己在未来的竞争力, 工作中遇到的任何基础技术一定要多问几个为什么, 多去了解一下这些技术的产生背景和基本原理.

&emsp;关于写博客, 我认为写博客和教别人都是非常重要的技术输出手段, 对于每一个开发者都很有必要, 写博客一定要写自己亲身实践的, 不能硬搬一些官方的文章, 不然也就失去了意义了, 对于每一个技术, 都要了解它的产生背景, 适用场景和基本原理.

#### 基本概念

关于HTTPS, 有很多很多的基本概念, 这里简单总结一下需要了解的.

* 对称加密

加密和解密使用的是同一套密钥, 实际开发工作中用得比较少.优点是计算速度快.对于网络传输来说, 缺点是不安全, 因为加密和解密都是同一套密钥, 通信双方都需要知道这个密钥, 密钥传输过程中容易被劫持.

* 非对称加密

简单地说, 非对称加密是有一对公钥和私钥, 用公钥加密以后的内容只能使用对应的私钥来解密, 使用私钥加密的内容只能使用公钥来解密, 而且不能通过公钥来推导出私钥, 反之亦然.和对称加密相比, 计算速度慢, 但是非常适合在不可靠的网络环境中传输可靠消息.

```
# 下面是用OpenSSL命令来制作RSA私钥/公钥, 并演示加密解密的方法

# 使用OpenSSL生成RSA私钥(生成的文件名为rsa, 里面内容其实包含了公钥和私钥)
# openssl genrsa -out rsa.pem 2048
# 从上面生成的密钥中导出公钥
# openssl rsa -in rsa.pem -pubout -out rsa.pub
# 新建一个文件test.txt
# echo "Hi, Rocky!" > test.txt
# 使用公钥加密该文件
# openssl rsautl -encrypt -in test.txt -inkey rsa.pub -pubin -out test.txt.encrypted
# 使用私钥解密该文件
# openssl rsautl -decrypt -in test.txt.encrypted -inkey rsa.pem -out test.txt.decrypt
# 对比test.txt和test.txt.decrypt的MD5值是一致的.
```

* 消息摘要

消息摘要能够将不同长度的输入经过某种hash算法计算出固定长度的输出, 并且输入不同, 输出肯定不同.常用于校验内容的完整性, 比如下载某些软件的时候, 都会附带该软件的指纹信息.常用的消息摘要算法是MD5和SHA256, 建议使用SHA256, 据说更安全, OpenSSL的默认消息摘要算法已经由MD5改成了SHA256.

#### HTTPS的产生背景

HTTPS解决的问题总结下来有2点:

* 保证消息的可靠传输,数据的完整性

说白了就是防止网络传输的中间环节来截获用户的密码, 防止不良运营商偷偷在正常网页上添加自己的广告, 因为HTTP协议都是明文可见的, 别人在中间改了以后服务端和客户端都是不知道的.

*  提供对网站的身份认证

简单说就是HTTPS能保证你打开的淘宝是真的淘宝不是坏人搭建的那个假淘宝.

#### HTTPS证书的种类

一般在购买/申请证书的时候总是能看到OV, DV, EV等域名种类, 这是什么呢? 我们的证书都是通过CA厂商来签发的, 签发的时候会提供不同的信息给CA厂商, 提供的信息越多, CA厂商也就替你背书越多, 具体分3种证书:

* DV(Domain Validated)域名验证

这种证书一般用于个人或者小公司, 一般使用域名验证的方式来签发证书, 常见的是使用域名的TXT类型解析来向CA厂商证明你对该域名的所有权, 我们常见的免费的SSL证书都是这种, 比如`Let's encrypt`创建的证书

* OV(Orgnization Validated)组织验证

申请的时候比DV稍微严格一点, 需要公司信息等. 一般是收费的, 不过对于浏览器来说跟DV没啥区别.都没有公司的标致.

* EV(Extended Validated)扩展验证

申请这个比OV更加严格, 价格也更贵, 这个的好处是浏览器上打开网站的时候会出现公司的名称, 对小白用户体验会更好点吧.
![image](https://user-images.githubusercontent.com/7486508/46863032-e46b3b00-ce48-11e8-93d4-4ebaca04b250.png)

证书的种类解决的更多的是`提供对网站身份认证`这个问题.

可以申请单域名的证书, 也可以申请支持通配符的证书, 比如`*.rockywu.me`, 通配符的更容易维护, 不过这里有一点要注意, `*.rockywu.me`证书只能支持到二级域名, 不支持`abc.edf.rockywu.me`.

#### 关于证书签发

上面提到了所有的HTTPS的证书都是直接或者间接由CA厂商来签发的.CA(数字证书认证机构)是负责发放和管理数字证书的权威机构, 承担公钥体系中公钥的合法性检验的责任,CA组织的公钥集合就是所谓的根证书, 会被预置到所有操作系统, 编程语言, 浏览器等中.

在申请数字证书之前，您必须先生成证书私钥和证书请求文件(CSR,Cerificate Signing Request),CSR是您的公钥证书原始文件，包含了您的服务器信息和您的单位信息，需要提交给CA认证中心。在生成CSR文件时会同时生成私钥文件，请妥善保管和备份您的私钥。CSR其实就是RSA生成的公钥部分外加一些自己公司的信息的一个文件, 然后把这个文件交给CA机构, CA机构使用它们的私钥签名生成一个文件给你, 这个文件就是你的网站的公钥证书, 如果是CA根证书签发的, 那么就会给你一个文件, 因为根证书签发的, 浏览器中的根证书就可以识别, 如果是二级CA签发的, 会给你2段文本组成的文件, PEM格式的文件会以类似这样的分隔符分隔`-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----`, 最上面的是你的签名证书, 下面的是二级厂商的签名证书.这样的一个文件浏览器中的根证书也能够信任, 因为信任连的存在.


#### HTTPS简单链接过程

![image](https://user-images.githubusercontent.com/7486508/46869857-9f9ece80-ce5f-11e8-84a8-7fe049748b9a.png)

#### 参考链接

* https://developers.google.com/web/fundamentals/security/encrypt-in-transit/intro-to-security-terminology
* 