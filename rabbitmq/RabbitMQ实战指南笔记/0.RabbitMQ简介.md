&emsp;`RabbitMQ`是一个非常流行的消息中间件.我们大约在2017年下半年的时候使用到了这个软件, 当时的背景是这样的, 秒拍项目开始是一个小项目, 采用PHP开发的, 只有一个代码仓库, 由于业务高速发展, 当时为了快速开发, 软件架构什么也没有考虑, 所有的项目都在一个git项目上, 随着时间的推移, 早期的技术债务早晚还是要还的.

&emsp;后来所有业务都在一个git项目上这个情况严重拖慢了开发进度, 技术leader决定采用微服务来重构, 重构的过程中就会涉及业务的解耦, 没错, RabbitMQ登场了, 当时公司基本上没有运维, 可以说只有我一个专门做运维的, 其他的都是从开发部门调过来的, 当时选择RabbitMQ的原因也很现实-`支持PHP语言`, 于是就做了技术选型. 当时稀里糊涂的由我来负责搭建RabbitMQ, 这是我第一次接触消息中间件.

#### RabbitMQ的使用场景

作为一个务实的技术人, 离开业务场景的技术都是瞎掰.

* 解耦

各个服务之间的很多数据都可以使用RabbitMQ来传递, 达到解耦的作用.

* 削峰

举一个实际的业务场景, 公司的创作者平台负责上传视频, 转码团队负责把用户上传的视频做转码处理, 视频上传速度很快, 但是转码的速度很慢, 这里使用了MQ进行通信, 有一定的削峰作用.

* 异步

这个最为常见, 新用户注册发邮件是一个很好的例子.

![image](https://user-images.githubusercontent.com/7486508/44586961-0bf83c80-a7e4-11e8-8cc8-94bdf898c746.png)

#### exchange分类

exchange有4个类型, 不同类型的路由规则不同, 这里我说一下我的理解, 由于公司的开发团队很多, 他们之间的数据格式也是各种各样, 为了给予开发最大限度的自由, 我们公司都是使用的`fanout`类型的exchange, 这个类型的路由特点是, 发到这个exchange上的消息会发送到所有绑定到该exchange上的queue, 无视routingkey的存在, 可以让业务使用不同的字段来区分不同类型的数据, 这样既给予了开发最大限度的自由, 又不会让运维整天修改路由规则.

exchange和queue创建的时候都设置成为`durable=True`, 这样不会因为MQ重启而消失.

#### 账号密码

最安全的做法是每一个exchange和queue一个密码, 但是由于queue众多, 自动化还不完善, 我们一套集群采用了一个账号密码, 分为只读账号, 只写账号和监控查看账号. 业务的账号不具有创建和绑定的权限, 只能读或者写.这样在一定程度上保证了线上MQ的安全性.