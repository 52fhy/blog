####背景简介

&emsp;公司运营部门最近要在望京SOHO楼下的商家做活动,来推广`好近APP`,公司的APP放在 http://fir.im 上面,大小为10M左右,楼下的带宽不是很给力,大概4M左右吧,做活动的时候,同时有50人左右来店里连接WiFi下载APP.如果用店里的WiFi下载的话,会很慢很慢的啊~所以决定修改一下路由器,来制作APP局域网分发.

&emsp;第一次搞的时候,因为目标只是简单的实现需求,做到内网分发就行,当时只是随便拿了一个路由器然后拿着自己的ubuntu电脑,电脑上装着nginx,把官网搬过来,下载连接一修改就搞定了,但是iphone的就不行,因为需要https,最终结果是做活动的时候,拿着路由器,交换机,电脑~~我擦,真他妈复杂,结果只实现了android的分发,因为安卓的安全机制很挫,直接拿一个安装包就可以了.下面依次解释一下遇到的坑吧~

---

#####ios客户端的局域网分发

&emsp;首先明白,要解决的问题是安装包过大(10M左右),搞线下活动时候,下载非常集中,而且网络环境不好控制,不稳定.关键是让客户端从局域网获取APP,开始没搞明白ios的安装包的安装机制,只是简单看了网上的资料所需要https,所以又学习如何搞定https(回头抽时间总结一下https的原理),从钟林那边学会了从 https://www.startssl.com 这个网站上可以免费申请https,前提是有一个自己的域名,网上资料很多,在此不必过多解释,好戏在后面,且听我慢慢道来~,折腾了一个晚上搞定了https, https://rockywu.me 但是当我把相关的ssl部署到内网的nginx上的时候,也就是把域名指向一个内网地址,来让客户端去链接,但是多次尝试后发现safari浏览器(ios安装非appstore软件的时候必须通过safari打开这个https连接,坑爹~)认为我这个局域网中的地址不是https的,不可信,打不开网站,实在搞不明白,回头真的要好好看看https的机制了,最后也搞定ios的内网分发,正在山重水复疑无路的时候,我把我的疑惑告诉了世军,正巧他之前搞过,他也知道需要https,但他自己没有搭建,它利用了github提供的纯天然免费的https,他搞定了,他告诉了我一个很重要的线索,就是plist文件不一定要跟程序包本身在一起,只有plist文件需要有https的环境,软件包位置本身是不需要的,知道真相的我眼泪掉下来,最后只是把plist文件放到了gitcafe上,国内的https还是更快一些的,把plist文件里的程序包的路径指向了内网的nginx本身,擦,搞定啦~下面是下载页面的配置以及plist文件的内容.

这是下载页面的关键代码,也可以添加一些其他的元素样式之类的.

```
<a href="itms-services://?action=download-manifest&url=https://raw.githubusercontent.com/hellorocky/project/master/n
ear.plist">苹果 下载</a> 
```

这是plist文件内容,关键三点,软件位置,版本,跟名称.

```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>items</key>
	<array>
		<dict>
			<key>assets</key>
			<array>
				<dict>
					<key>kind</key>
					<string>software-package</string>
					<key>url</key>
					<string>http://192.168.1.1/Near.ipa</string>
				</dict>
			</array>
			<key>metadata</key>
			<dict>
				<key>bundle-identifier</key>
				<string>com.qmm.NearEnt</string>
				<key>bundle-version</key>
				<string>0.1.12</string>
				<key>kind</key>
				<string>software</string>
				<key>title</key>
				<string>好近</string>
			</dict>
		</dict>
	</array>
</dict>
</plist>
```
