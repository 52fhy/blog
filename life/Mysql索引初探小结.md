> 理论源于实践,保证写的每一篇博客都经过充分的测试

## 背景介绍

&emsp;最近同事在搞慢查询的相关问题,我就看了看我们这边相关的设置,发现`slow.log`中大量的日志刷刷的,但仔细看不是每个都超过了慢查询的时间,怎么回事?查了以后发现了一个参数` log_queries_not_using_indexes`,这个参数的意思是记录没有使用索引的查询到`slow.log`中,后来联想到工作中经常遇到创建索引的情况,一遇到查询慢就创建索引,但没有真正了解过索引,如何建立索引,索引的顺序如何,这怎么行呢,所以花了点时间总结了一下,这篇文章只是入门,稍后会出一篇高级的用法的文章.

> 最好的学习方式就是从工作的点滴中寻找知识点,并深入总结,这样你就会有殊途同归的感觉,并会深深地认同`程序=算法+数据结构`这一理念,不要陷入繁琐的业务逻辑中,也不要陷入理论的深潭中,理论源于实践.

## 索引的本质和作用

&emsp;在谈论这个问题的时候,我们可以想想图书馆中,存放着一架一架的图书,如果我想找某一本书的话还的一本一本地查找直到找到我想要的那一本书为止,这样的查找肯定费时费力,动一动脑子后,我们可以按照书的名字字母的顺序来顺序存放,建立索引卡片信息(比如A,B等等),跟字典类似,这样的话在查找之前我们可以先看一下卡片来确定大概位置然后依次搜索到想要的书,这就是生活中的索引举例,当然有很多很多(字典).他们的原理都是一样的,通过不断地缩小想要获得数据的范围来筛选出最终的结果,同时把随机事件变成顺序事件,也就是我们总是通过同一种查找方式来锁定数据而不是遍历所有数据这种随机事件查找.

&emsp;Mysql官方对索引的定义为:索引是帮助mysql高效获取数据的数据结构.提取句子主干,就可以知道索引的本质:索引是数据结构.简单来说,索引是值到行位置的映射,索引就是一个目录,目的是快速找到记录,这是索引的基本功能,当然索引还有其它功能,本文只讨论基本功能.

&emsp;我们知道,数据库最重要的功能之一,一般的系统读的比写的多,而且插入操作和更新操作很少出现性能问题,遇到最多的就是复杂的查询操作,所以查询语句的优化显然是重中之重.我们都希望查询的数据尽可能地块,因此数据库系统的设计者会从查询算法的角度进行优化.最基本的查询算法当然是顺序查找(linear search),这种复杂度为O(n)的算法在数据量很大时显然是糟糕的,好在计算机科学的发展提供了更多优秀的查找算法,例如二分查找,二叉树查找等.稍微分析一下就会发现,每一种查找算法都只能应用于特定的数据结构之上,例如二分查找要求被检索数据有序,而二叉树只能应用于二叉查找树上,但是数据本身的组织结构不可能完全满足各种数据结构(例如,理论上不可能同时将两列都按照顺序进行组织),所以在数据之外,数据库系统还维护着满足特定查找算法的数据结构,这些数据结构以某种方式引用(指向)数据,这样就可以在这些数据结构上实现高级查找算法.这种数据结构就是索引.看一个例子吧:

![索引举例](http://rockywu.me/static_files/image/mysql_index1.png)
图1展示了一种可能的索引方式.左边是数据表,一共有两列七条记录,最左边的是数据记录的物理地址(注意逻辑上相邻的记录在磁盘上也并不是一定物理相邻的).为了加快Col2的查找,可以维护一个右边所示的二叉查找树,每个节点分别包含索引键值和一个指向对应数据记录物理地址的指针,这样就可以运用二叉查找在O(log2n)的复杂度内获取到相应的数据.
虽然这是一个货真价实的索引,但是实际的数据库系统几乎没有使用二叉查找树或其进化品种红黑树来实现的,原因会在后面介绍的.索引对于良好的性能非常关键,尤其是当表中得数量越来越大的时候.

&emsp;索引的作用是利用指定的列来快速定位记录的.如果没有索引,mysql必须从第一行一次查找直到找到所想要找的值,也是是所谓的全表扫描,表越大花费的时间也就越长.如果对于指定的列有索引的话,MySQL可以快速定位所要查找值的位置而不用全表扫描,当然快很多啊.绝大多数的mysql索引(主键索引,唯一索引,普通索引,全文索引)都存储在B

## 索引的常见分类

&emsp;索引有很多种类型,所以为不同的场景提供更好的性能.在mysql中,是在存储引擎而不是服务器层实现的.所以并没有统一的索引标准:不同存储引擎的索引的工作方式并不一样,也不是所有的存储引擎都支持所有类型的索引.即使多个存储引擎支持同一种类型的索引,其底层的实现也可能不同.这里我主要介绍innodb引擎上,因为这是目前使用最多的存储引擎.innodb目前只支持B+tree数据结构的索引,这里只是简单提及该数据结构后续会出一篇专门介绍B+tree数据结构的文章.

* 从数据结构角度

 1. B+树索引
 2. hash索引

## 索引的基本设置方法/查看方法

* 查看方法:

```
>show index from tablename\G;
*************************** 1. row ***************************
        Table: profile #表名称
   Non_unique: 0 #0代表索引不可以重复,1代表可以重复
     Key_name: PRIMARY #索引的名称,如果是主键索引,那么名字只能是
 Seq_in_index: 1
  Column_name: id
    Collation: A
  Cardinality: 1092066
     Sub_part: NULL
       Packed: NULL
         Null:
   Index_type: BTREE
      Comment:
Index_comment:
*************************** 2. row ***************************
        Table: profile
   Non_unique: 0
     Key_name: idx_user_id
 Seq_in_index: 1
  Column_name: user_id
    Collation: A
  Cardinality: 1092066
     Sub_part: NULL
       Packed: NULL
         Null:
   Index_type: BTREE
      Comment:
Index_comment:

```



## 索引的弊端
