#### 背景介绍

&emsp;现代的互联网, 已经是一个全面HTTPS的时代了, 感谢Let's Encrypt为我们免费提供了HTTPS的证书, 这里介绍一下使用方法.

#### 使用方法

基本环境:

```
CentOS7 + Nginx 
```

* 安装certbot

certbot是一个制作证书的客户端工具

```
yum install certbot-nginx
```

* 配置nginx验证路径

certbot在制作证书的时候会先验证该域名, 配置如下:

```
server {
  	listen       80 default_server;
  	
  	...
  	
	location ^~ /.well-known/acme-challenge/ {   
		default_type "text/plain";   
		root     /home/rocky/test;
	}
	
	location = /.well-known/acme-challenge/ {   
		return 404;
	}
}

```


* 制作证书

```
[root]# certbot certonly --webroot -w /home/rocky/test -d rockywu.me
```

安装成功后，默认会在 /etc/letsencrypt/live/rockywu.me/ 会生成CA证书。

咱们会用到的是下面这两个:

```
|-- fullchain.pem 
|-- privkey.pem
```

* 配置Nginx HTTPS

```
# 禁止通过IP来请求nginx
server {
    listen 443;
    ssl_certificate     /etc/letsencrypt/live/rockywu.me/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/rockywu.me/privkey.pem;
    return 500;
}
server {
    listen 80;
    return 500;
}

server {
    listen 80;
	server_name rockywu.me;
    rewrite ^(.*) https://rockywu.me$1 permanent;
}

server {
    listen 443 ssl;
	server_name rockywu.me;
    ssl_certificate     /etc/letsencrypt/live/rockywu.me/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/rockywu.me/privkey.pem;
	access_log /home/rocky/nginx/logs/rockywu_me_access.log;
	error_log /home/rocky/nginx/logs/rockywu_me_error.log;


	location / {
        default_type text/plain;
        return 200 "OK";
	}

    # 用于自动续签ssl证书, 到时候直接执行run "certbot renew"即可更新
    location ^~ /.well-known/acme-challenge/ {
        default_type "text/plain";
        root     /home/rocky/test;
    }

    location = /.well-known/acme-challenge/ {
        return 404;
    }



}
```

* 添加定时任务

默认情况下, 证书的有效期为3个月, 我们可以添加一个crontab来自动更新.

```
每个月执行一次
root:
0 0 1 * * /bin/certbot renew >/dev/null 2>&1

由于我的nginx安装在rocky用户下
rocky:
5 0 1 * * /home/rocky/nginx/sbin/nginx -s reload
```
